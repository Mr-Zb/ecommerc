<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fun.admin.repository.SchMapper">
	<resultMap id="SchSchemeInfo" type="com.fun.le.entities.SchSchemeInfo">
		<id property="pkId" javaType="Integer" column="pk_id" jdbcType="INTEGER" />
		<id property="dataVersion" javaType="Integer" column="data_version" jdbcType="TINYINT" />
		<result property="createUser" javaType="Integer" column="create_user" jdbcType="INTEGER" />
		<result property="createTime" javaType="Date" column="create_time" jdbcType="TIMESTAMP" />
		<result property="updateUser" javaType="Integer" column="update_user" jdbcType="INTEGER" />
		<result property="updateTime" javaType="Date" column="update_time" jdbcType="TIMESTAMP" />
		<result property="productId" javaType="Integer" column="product_id" jdbcType="INTEGER" />
		<result property="memberId" javaType="Integer" column="member_id" jdbcType="INTEGER" />
		<result property="memberName" javaType="String" column="member_name" jdbcType="CHAR" />
		<result property="memberLevel" javaType="Integer" column="member_level" jdbcType="INTEGER" />
		<result property="agentId" javaType="Integer" column="agent_id" jdbcType="INTEGER" />
		<result property="agentName" javaType="String" column="agent_name" jdbcType="CHAR" />
		<result property="agentFullId" javaType="String" column="agent_full_id" jdbcType="CHAR" />
		<result property="agentFullName" javaType="String" column="agent_full_name" jdbcType="CHAR" />
		<result property="scheneNo" javaType="String" column="schene_no" jdbcType="CHAR" />
		<result property="schemeState" javaType="Integer" column="scheme_state" jdbcType="TINYINT" />
		<result property="cancellationFlag" javaType="Integer" column="cancellation_flag" jdbcType="TINYINT" />
		<result property="authFlag" javaType="Integer" column="auth_flag" jdbcType="TINYINT" />
		<result property="title" javaType="String" column="title" jdbcType="CHAR" />
		<result property="royalty" javaType="Integer" column="royalty" jdbcType="TINYINT" />
		<result property="endIssue" javaType="String" column="end_issue" jdbcType="CHAR" />
		<result property="endTime" javaType="Date" column="end_time" jdbcType="TIMESTAMP" />
		<result property="nextEndIssue" javaType="String" column="next_end_issue" jdbcType="CHAR" />
		<result property="nextEndTime" javaType="Date" column="next_end_time" jdbcType="TIMESTAMP" />
		<result property="nextOpenIssue" javaType="String" column="next_open_issue" jdbcType="CHAR" />
		<result property="nextOpenTime" javaType="Date" column="next_open_time" jdbcType="TIMESTAMP" />
		<result property="amount1" javaType="Double" column="amount1" jdbcType="DECIMAL" />
		<result property="amount2" javaType="Double" column="amount2" jdbcType="DECIMAL" />
		<result property="amount3" javaType="Double" column="amount3" jdbcType="DECIMAL" />
		<result property="amount4" javaType="Double" column="amount4" jdbcType="DECIMAL" />
		<result property="amount5" javaType="Double" column="amount5" jdbcType="DECIMAL" />
		<result property="amount6" javaType="Double" column="amount6" jdbcType="DECIMAL" />
		<result property="gather" javaType="Integer" column="gather" jdbcType="INTEGER" />
		<result property="minimum" javaType="Integer" column="minimum" jdbcType="INTEGER" />
		<result property="gatherd" javaType="Integer" column="gatherd" jdbcType="INTEGER" />
		<result property="schemeSchedule" javaType="Integer" column="scheme_schedule" jdbcType="INTEGER" />
		<result property="schemeLocked" javaType="Integer" column="scheme_locked" jdbcType="TINYINT" />
		<result property="totalIssue" javaType="Integer" column="total_issue" jdbcType="TINYINT" />
		<result property="expressIssue" javaType="Integer" column="express_issue" jdbcType="TINYINT" />
		<result property="totalMultiple" javaType="Integer" column="total_multiple" jdbcType="TINYINT" />
		<result property="niceName" javaType="String" column="nice_name" jdbcType="CHAR" />
	</resultMap>

	<resultMap id="BuyDetailsDto" type="com.fun.admin.dto.BuyDetailsDto">
		<id property="pkId" javaType="Integer" column="pk_id" jdbcType="INTEGER" />
		<result property="orderTime" javaType="Date" column="order_time" jdbcType="TIMESTAMP" />
		<result property="schemeNo" javaType="String" column="scheme_no" jdbcType="CHAR" />
		<result property="productId" javaType="Integer" column="product_id" jdbcType="INTEGER" />
		<result property="schemeId" javaType="Integer" column="scheme_id" jdbcType="INTEGER" />
		<result property="productName" javaType="String" column="product_name" jdbcType="CHAR" />
		<result property="lotIssue" javaType="String" column="lot_issue" jdbcType="CHAR" />
		<result property="memId" javaType="Integer" column="mem_id" jdbcType="INTEGER" />
		<result property="memName" javaType="String" column="mem_name" jdbcType="CHAR" />
		<result property="amount1" javaType="Double" column="amount1" jdbcType="DECIMAL" />
		<result property="amount2" javaType="Double" column="amount2" jdbcType="DECIMAL" />
		<result property="amount3" javaType="Double" column="amount3" jdbcType="DECIMAL" />
		<result property="amount4" javaType="Double" column="amount4" jdbcType="DECIMAL" />
		<result property="persient" javaType="Double" column="persient" jdbcType="DECIMAL" />
		<result property="buyType" javaType="Integer" column="buy_type" jdbcType="INTEGER" />
		<result property="schemeState" javaType="Integer" column="scheme_state" jdbcType="INTEGER" />
	</resultMap>

	<resultMap id="WinningDetailsDto" type="com.fun.admin.dto.WinningDetailsDto">
		<id property="pkId" javaType="Integer" column="pk_id" jdbcType="INTEGER" />
		<result property="orderTime" javaType="Date" column="order_time" jdbcType="TIMESTAMP" />
		<result property="schemeNo" javaType="String" column="scheme_no" jdbcType="CHAR" />
		<result property="productId" javaType="Integer" column="product_id" jdbcType="INTEGER" />
		<result property="schemeId" javaType="Integer" column="scheme_id" jdbcType="INTEGER" />
		<result property="productName" javaType="String" column="product_name" jdbcType="CHAR" />
		<result property="lotIssue" javaType="String" column="lot_issue" jdbcType="CHAR" />
		<result property="memId" javaType="Integer" column="mem_id" jdbcType="INTEGER" />
		<result property="memName" javaType="String" column="mem_name" jdbcType="CHAR" />
		<result property="amount1" javaType="Double" column="amount1" jdbcType="DECIMAL" />
		<result property="amount2" javaType="Double" column="amount2" jdbcType="DECIMAL" />
		<result property="amount3" javaType="Double" column="amount3" jdbcType="DECIMAL" />
		<result property="amount4" javaType="Double" column="amount4" jdbcType="DECIMAL" />
		<result property="persient" javaType="Double" column="persient" jdbcType="DECIMAL" />
		<result property="buyType" javaType="Integer" column="buy_type" jdbcType="INTEGER" />
		<result property="schemeState" javaType="Integer" column="scheme_state" jdbcType="INTEGER" />
	</resultMap>

	<!-- 查询合买中心列表 -->
	<select id="listTogeterList" parameterType="Map" resultMap="SchSchemeInfo">
		<![CDATA[
		SELECT
			t.pk_id,
			t.member_name,
			t.nice_name,
			t.member_level,
			t.product_id,
			t.end_issue,
			t.amount1,
			t.gather,
			t.gatherd,
			t.minimum,
			t.scheme_state
		FROM
			t_sch_scheme_info t
		]]>
		 <where>
		    <![CDATA[AND t.data_version = '1']]>
			<![CDATA[AND t.gather > '1']]>
			<!-- <![CDATA[AND t.scheme_state = '1']]> -->
		    <if test="prodId != null and prodId > 0">
			<![CDATA[AND t.product_id = #{prodId, jdbcType=INTEGER}]]>
			</if>
		 	<if test="minSchedule != null and minSchedule > 0">
			<![CDATA[AND t.scheme_schedule >= #{minSchedule, jdbcType=INTEGER}]]>
			</if>
			<if test="maxSchedule != null and maxSchedule > 0">
			<![CDATA[AND t.scheme_schedule <= #{maxSchedule, jdbcType=INTEGER}]]>
			</if>
			<if test="minAmount != null and minAmount > 0">
			<![CDATA[AND t.amount1 >= #{minAmount, jdbcType=DECIMAL}]]>
			</if>
			<if test="maxAmount != null and maxAmount > 0">
			<![CDATA[AND t.amount1 <= #{maxAmount, jdbcType=DECIMAL}]]>
			</if> 
			<if test="member != null and member != ''">
			<![CDATA[AND t.nice_name LIKE '%${member}%']]>
			</if>
			<if test="userId != null and userId gt 0">
			<![CDATA[AND t.member_id = #{userId, jdbcType=INTEGER}]]>
			</if>
		</where> 
		<![CDATA[
		ORDER BY
			t.pk_id DESC
		]]>
	</select>
	
	<!-- 查询合买中心列表 1-->
	<select id="listTogeterList1" parameterType="Map" resultMap="SchSchemeInfo">
		<![CDATA[
		SELECT
			t.pk_id,
			t.member_name,
			t.nice_name,
			t.member_level,
			t.product_id,
			t.end_issue,
			t.amount1,
			t.gather,
			t.gatherd,
			t.minimum,
			t.scheme_state
		FROM
			t_sch_scheme_info t
		]]>
		 <where>
		    <![CDATA[AND t.data_version = '1']]>
			<![CDATA[AND t.gather > '1']]>
			<![CDATA[AND t.scheme_state = '1']]>
		    <if test="prodId != null and prodId > 0">
			<![CDATA[AND t.product_id = #{prodId, jdbcType=INTEGER}]]>
			</if>
		 	<if test="minSchedule != null and minSchedule > 0">
			<![CDATA[AND t.scheme_schedule >= #{minSchedule, jdbcType=INTEGER}]]>
			</if>
			<if test="maxSchedule != null and maxSchedule > 0">
			<![CDATA[AND t.scheme_schedule <= #{maxSchedule, jdbcType=INTEGER}]]>
			</if>
			<if test="minAmount != null and minAmount > 0">
			<![CDATA[AND t.amount1 >= #{minAmount, jdbcType=DECIMAL}]]>
			</if>
			<if test="maxAmount != null and maxAmount > 0">
			<![CDATA[AND t.amount1 <= #{maxAmount, jdbcType=DECIMAL}]]>
			</if> 
			<if test="member != null and member != ''">
			<![CDATA[AND t.nice_name LIKE '%${member}%']]>
			</if>
			<if test="userId != null and userId gt 0">
			<![CDATA[AND t.member_id = #{userId, jdbcType=INTEGER}]]>
			</if>
		</where> 
		<![CDATA[
		ORDER BY
			t.pk_id DESC
		]]>
	</select>
	
	
	
	<!-- 查询近期截止的订单 -->
	<select id="listSchemesForEndTask" parameterType="Map" resultMap="SchSchemeInfo">
		<![CDATA[
		SELECT
			t.pk_id,
			t.product_id,
			t.end_time
		FROM
			t_sch_scheme_info t
		]]>
		<where>
		<![CDATA[AND t.scheme_state IN ('1', '2')]]>
		<![CDATA[AND t.end_time <= #{endTime, jdbcType=TIMESTAMP}]]>
		</where>
	</select>

	<!-- 查询近期开奖方案 -->
	<select id="listSchemesForRewardTask" parameterType="Map" resultMap="SchSchemeInfo">
		<![CDATA[
		SELECT
			t.pk_id,
			t.product_id,
			t.next_open_issue
		FROM
			t_sch_scheme_info t
		]]>
		<where>
		<![CDATA[AND t.data_version = '1']]>
		<![CDATA[AND t.scheme_state IN ('5','6')]]>
		<![CDATA[AND t.express_issue < t.total_issue]]>
		</where>
	</select>

	<!-- 分页查询方案列表 -->
	<select id="listSchemeDetails" parameterType="Map" resultMap="SchSchemeInfo">
		<![CDATA[
		SELECT
			t.pk_id AS pk_id,
			t.create_user AS create_user,
			t.create_time AS create_time,
			t.update_user AS update_user,
			t.update_time AS update_time,
			t.data_version AS data_version,
			t.product_id AS product_id,
			t.member_id AS member_id,
			t.member_name AS member_name,
			t.member_level AS member_level,
			t.agent_id AS agent_id,
			t.agent_name AS agent_name,
			t.agent_full_id AS agent_full_id,
			t.agent_full_name AS agent_full_name,
			t.schene_no AS schene_no,
			t.scheme_state AS scheme_state,
			t.cancellation_flag AS cancellation_flag,
			t.auth_flag AS auth_flag,
			t.title AS title,
			t.royalty AS royalty,
			t.end_issue AS end_issue,
			t.end_time AS end_time,
			t.next_end_issue AS next_end_issue,
			t.next_end_time AS next_end_time,
			t.next_open_issue AS next_open_issue,
			t.next_open_time AS next_open_time,
			t.amount1 AS amount1,
			t.amount2 AS amount2,
			t.amount3 AS amount3,
			t.amount4 AS amount4,
			t.amount5 AS amount5,
			t.amount6 AS amount6,
			t.gather AS gather,
			t.minimum AS minimum,
			t.gatherd AS gatherd,
			t.scheme_schedule AS scheme_schedule,
			t.scheme_locked AS scheme_locked,
			t.total_issue AS total_issue,
			t.express_issue AS express_issue,
			t.total_multiple AS total_multiple
		FROM
			t_sch_scheme_info t
		]]>
		<where>
			<if test="where.beginDate != null"><![CDATA[AND t.create_time >= #{where.beginDate, jdbcType=TIMESTAMP}]]></if>
			<if test="where.endDate != null"><![CDATA[AND t.create_time <= #{where.endDate, jdbcType=TIMESTAMP}]]></if>
			<if test="where.keyword != null and where.keyword != ''">
				<![CDATA[AND (t.member_id = '${where.keyword}' OR t.member_name = '${where.keyword}')]]>
			</if>
			<if test="offerType != null and offerType > 0">
				<choose>
					<when test="offerType == 1">
					<![CDATA[AND t.gather > 1]]>
					</when>
					<otherwise>
					<![CDATA[AND t.gather = 1]]>
					</otherwise>
				</choose>
			</if>
			<if test="scheme.productId != null and scheme.productId > 0"><![CDATA[AND t.product_id = #{scheme.productId, jdbcType=INTEGER}]]></if>
			<if test="scheme.schemeState != null and scheme.schemeState > 0">
				<choose>
					<when test="scheme.schemeState == 3">
						<![CDATA[AND t.scheme_state IN ('3', '7')]]>
					</when>
					<otherwise><![CDATA[AND t.scheme_state = #{scheme.schemeState, jdbcType=INTEGER}]]></otherwise>
				</choose>
			</if>
			<if test="scheme.scheneNo != null and scheme.scheneNo != ''"><![CDATA[AND t.schene_no = #{scheme.scheneNo, jdbcType=CHAR}]]></if>
		</where>
		<![CDATA[ORDER BY t.pk_id DESC]]>
	</select>

	<!-- 管理员查询购彩明细 -->
	<select id="listBuyDetails" parameterType="Map" resultMap="BuyDetailsDto">
		<![CDATA[
		SELECT
			tssi.pk_id AS pk_id,
			tsso.create_time AS order_time,
			tsso.member_id AS mem_id,
			tsso.member_name AS mem_name,
			tsso.scheme_id AS scheme_id,
			tssi.schene_no AS scheme_no,
			tssi.product_id AS product_id,
			tssi.end_issue AS lot_issue,
			tssi.amount1 AS amount1,
			tssi.amount2 * tsso.offer_num AS amount2,
			tssi.amount6 AS amount3,
			tssi.amount6 * tsso.offer_num / tssi.gather AS amount4,
			tsso.offer_num / tssi.gather AS persient,
			tsso.offer_type AS buy_type,
			tssi.scheme_state AS scheme_state
		FROM
			t_sch_scheme_offer tsso
		LEFT JOIN t_sch_scheme_info tssi ON tsso.scheme_id = tssi.pk_id
		]]>
		<where>
			<if test="where.beginDate != null"><![CDATA[AND tsso.create_time >= #{where.beginDate, jdbcType=TIMESTAMP}]]></if>
			<if test="where.endDate != null"><![CDATA[AND tsso.create_time <= #{where.endDate, jdbcType=TIMESTAMP}]]></if>
			<if test="where.keyword != null and where.keyword != ''">
				<![CDATA[AND (tsso.member_id = '${where.keyword}' OR tsso.member_name = '${where.keyword}')]]>
			</if>
			<if test="offerType != null and offerType > 0">
				<choose>
					<when test="offerType == 2">
					<![CDATA[AND tsso.offer_type IN ('2', '4')]]>
					</when>
					<otherwise>
					<![CDATA[AND tsso.offer_type = #{offerType, jdbcType=INTEGER}]]>
					</otherwise>
				</choose>
			</if>
			<if test="scheme.productId != null and scheme.productId > 0"><![CDATA[AND tssi.product_id = #{scheme.productId, jdbcType=INTEGER}]]></if>
			<if test="scheme.schemeState != null and scheme.schemeState > 0">
				<choose>
					<when test="scheme.schemeState == 3">
						<![CDATA[AND tssi.scheme_state IN ('3', '7')]]>
					</when>
					<otherwise><![CDATA[AND tssi.scheme_state = #{scheme.schemeState, jdbcType=INTEGER}]]></otherwise>
				</choose>
			</if>
			<if test="scheme.schemeNo != null and scheme.schemeNo != ''"><![CDATA[AND tssi.schene_no = #{scheme.schemeNo, jdbcType=CHAR}]]></if>
		</where>
		<![CDATA[ORDER BY tsso.pk_id DESC]]>
	</select>
	
	<!-- 管理员查询购彩明细 -->
	<select id="listBuyDetailsNew" parameterType="Map" resultMap="BuyDetailsDto">
		<![CDATA[
		SELECT
			tssi.pk_id AS pk_id,
			tsso.create_time AS order_time,
			tsso.member_id AS mem_id,
			tsso.member_name AS mem_name,
			tsso.scheme_id AS scheme_id,
			tssi.schene_no AS scheme_no,
			tssi.product_id AS product_id,
			tssi.end_issue AS lot_issue,
			tssi.amount1 AS amount1,
			tssi.amount2 * tsso.offer_num AS amount2,
			tssi.amount6 AS amount3,
			tssi.amount6 * tsso.offer_num / tssi.gather AS amount4,
			tsso.offer_num / tssi.gather AS persient,
			tsso.offer_type AS buy_type,
			tssi.scheme_state AS scheme_state
		FROM
			t_sch_scheme_offer tsso
		LEFT JOIN t_sch_scheme_info tssi ON tsso.scheme_id = tssi.pk_id
		]]>
		<where>
			<if test="where.beginDate != null"><![CDATA[AND tsso.create_time >= #{where.beginDate, jdbcType=TIMESTAMP}]]></if>
			<if test="where.endDate != null"><![CDATA[AND tsso.create_time <= #{where.endDate, jdbcType=TIMESTAMP}]]></if>
		</where>
		<![CDATA[ AND tssi.scheme_state > 3]]>
		<![CDATA[ ORDER BY tsso.pk_id DESC]]>
	</select>
<!-- 查询方案列表 -->
	<select id="listSchemeDetailsNew" parameterType="Map" resultMap="SchSchemeInfo">
		<![CDATA[
		SELECT
			t.pk_id AS pk_id,
			t.create_user AS create_user,
			t.create_time AS create_time,
			t.update_user AS update_user,
			t.update_time AS update_time,
			t.data_version AS data_version,
			t.product_id AS product_id,
			t.member_id AS member_id,
			t.member_name AS member_name,
			t.member_level AS member_level,
			t.agent_id AS agent_id,
			t.agent_name AS agent_name,
			t.agent_full_id AS agent_full_id,
			t.agent_full_name AS agent_full_name,
			t.schene_no AS schene_no,
			t.scheme_state AS scheme_state,
			t.cancellation_flag AS cancellation_flag,
			t.auth_flag AS auth_flag,
			t.title AS title,
			t.royalty AS royalty,
			t.end_issue AS end_issue,
			t.end_time AS end_time,
			t.next_end_issue AS next_end_issue,
			t.next_end_time AS next_end_time,
			t.next_open_issue AS next_open_issue,
			t.next_open_time AS next_open_time,
			t.amount1 AS amount1,
			t.amount2 AS amount2,
			t.amount3 AS amount3,
			t.amount4 AS amount4,
			t.amount5 AS amount5,
			t.amount6 AS amount6,
			t.gather AS gather,
			t.minimum AS minimum,
			t.gatherd AS gatherd,
			t.scheme_schedule AS scheme_schedule,
			t.scheme_locked AS scheme_locked,
			t.total_issue AS total_issue,
			t.express_issue AS express_issue,
			t.total_multiple AS total_multiple
		FROM
			t_sch_scheme_info t
		]]>
		<where>
			<if test="where.beginDate != null"><![CDATA[AND t.create_time >= #{where.beginDate, jdbcType=TIMESTAMP}]]></if>
			<if test="where.endDate != null"><![CDATA[AND t.create_time <= #{where.endDate, jdbcType=TIMESTAMP}]]></if>
		</where>
		<![CDATA[ORDER BY t.pk_id DESC]]>
	</select>
	
	<select id="winningdetails" parameterType="Map" resultMap="WinningDetailsDto">
		<![CDATA[
		SELECT
			tssi.pk_id AS pk_id,
			tsso.member_id AS mem_id,
			tsso.member_name AS mem_name,
			tsso.create_time AS order_time,
			tsso.scheme_id AS scheme_id,
			tssi.schene_no AS scheme_no,
			tssi.product_id AS product_id,
			tssi.end_issue AS lot_issue,
			tssi.amount1 AS amount1,
			tssi.amount2 * tsso.offer_num AS amount2,
			tssi.amount6 AS amount3,
			tssi.amount6 * tsso.offer_num / tssi.gather AS amount4,
			tsso.offer_num / tssi.gather AS persient,
			tsso.offer_type AS buy_type,
			tssi.scheme_state AS scheme_state
		FROM
			t_sch_scheme_offer tsso
		LEFT JOIN t_sch_scheme_info tssi ON tsso.scheme_id = tssi.pk_id
		]]>
		<where>
			<![CDATA[AND tssi.scheme_state IN ('7', '8')]]>
			<if test="where.beginDate != null"><![CDATA[AND tsso.create_time >= #{where.beginDate, jdbcType=TIMESTAMP}]]></if>
			<if test="where.endDate != null"><![CDATA[AND tsso.create_time <= #{where.endDate, jdbcType=TIMESTAMP}]]></if>
			<if test="where.keyword != null and where.keyword != ''">
				<![CDATA[AND (tsso.member_id = '${where.keyword}' OR tsso.member_name = '${where.keyword}')]]>
			</if>
			<if test="offerType != null and offerType > 0">
				<choose>
					<when test="offerType == 2">
					<![CDATA[AND tsso.offer_type IN ('2', '4')]]>
					</when>
					<otherwise>
					<![CDATA[AND tsso.offer_type = #{offerType, jdbcType=INTEGER}]]>
					</otherwise>
				</choose>
			</if>
			<if test="scheme.productId != null and scheme.productId > 0"><![CDATA[AND tssi.product_id = #{scheme.productId, jdbcType=INTEGER}]]></if>
			<if test="scheme.schemeNo != null and scheme.schemeNo != ''"><![CDATA[AND tssi.schene_no = #{scheme.schemeNo, jdbcType=CHAR}]]></if>
		</where>
		<![CDATA[ORDER BY tsso.pk_id DESC]]>
	</select>
</mapper>